---
title: "Kristiansand Sammendragsstatistikk"
author: "David Barton, Bart Immerzeel and Willeke A'Campo"
date: "13. november 2023"
output:
  html_document: default
  pdf_document:  default
sansfont: Arial
knit: (function(inputFile, encoding) {
    rmarkdown::render(inputFile, encoding = encoding, output_dir = "../reports", output_format = "all")
    })
params:
  region:
    label: "Municipality"
    value: Kristiansand
    input: select
    choices: ["Bærum", "Bodø", "Kristiansand", "Oslo"]
  data: 
    label: "Input dataset:"
    value: bodo_registrerte_traer.csv
    input: file
  agol:
    label: Bytraeratlas link (AGOL)
    tag: ['baerum', 'bodo', 'kristiansand', 'oslo']
    value: 5191adc2c4b34658aea227c9853c6ebb
    input: select
    choices: ['bærum', '5191adc2c4b34658aea227c9853c6ebb', 'kristiansand', 'oslo']
---

```{r "setup", echo=FALSE, results='hide',message=FALSE, warning=FALSE}
# ---------------------------------------------------------------------------- #
# SETUP
# ---------------------------------------------------------------------------- #
# YAML header parmaters contain params used in both codeblocks and markdown text
# codeblock: params$region
# markdown:  `r params$region`
# YAML ../config/catalog.yaml contains paths to data and lookup tables
# configuration of the catalog is done Chunk "config"
# ---------------------------------------------------------------------------- #

#library(logger)

# data manipulation libraries
#library(plyr)
library(dplyr)
library(magrittr) # includes %>%
library(tidyverse) # includes dplyr
#library(reshape2)

# importing libraries
#library(import)
#library(usethis)

# plotting libraries
library(ggplot2)
#library(ggpubr)
#library(cowplot)
#library(scales)
#library(grid)

# reporting libraries
#library(knitr)
#library(DT)
#library(extrafont)
```

```{r "config", echo=FALSE, results='hide',message=FALSE, warning=FALSE}
# ---------------------------------------------------------------------------- #
# LOAD CATALOG
# IMPORTANT: point data_path to correct study area
# ---------------------------------------------------------------------------- #

# set encoding to UTF-8 (Norwegian characters)
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
logger::log_info("Encoding set to UTF-8")

# if the font is not in default search path e.g. `C:/Windows/Fonts/`
userpath <- path.expand("~")
#myfontPath <- file.path(userpath, "/AppData/Local/Microsoft/Windows/Fonts")
myfontPath <- "C:/Users/willeke.acampo/AppData/Local/Microsoft/Windows/Fonts"

#extrafont::font_import(pattern = "Roboto",
#            paths = myfontPath,
#            recursive = TRUE,
#            prompt = FALSE)

### Load fonts
# Options: "all", "pdf", "postscript", or "win"
extrafont::loadfonts(device = "all")
#extrafont::fonts()

# set theme globally
theme_set(theme_minimal(base_family = "Arial", base_size = 12))

# load local module
# remove /notebooks from wd
project_path <- gsub("/notebooks", "", getwd())
src_path <- file.path(project_path, "src")
config <- modules::use(file.path(src_path, "config.R"))
nina_theme <- modules::use(file.path(src_path, "nina_theme.R"))
nina_plot <- modules::use(file.path(src_path, "nina_plot.R"))

# load parameters and catalog from yaml files
catalog <- config$load_catalog(
  catalog_filepath = file.path(project_path, "config/catalog.yaml")
  )

# load data from correct STUDY AREA
data_path <- catalog$bodo_bytraer$filepath
lookup_attr_path <- catalog$lookup_attr$filepath
lookup_attr_sheet <- catalog$lookup_attr$sheet_1
logger::log_info(paste("Paths to files loaded. \n",
  "Data path:", data_path, "\n",
  "Lookup excel:", lookup_attr_path, "\n",
  "Lookup sheet:", lookup_attr_sheet, "\n"))
```

```{r "load data", echo=FALSE, results='hide',message=FALSE, warning=FALSE}
# ALL TREES
df <- read.csv(file = data_path, header = TRUE, sep = ";", dec = ",",
               stringsAsFactors = FALSE)
df$class <- "Alle traer"
# if NULL set to "15% - 20%"
df$percent_crown_missing[is.na(df$percent_crown_missing)] <- "15% - 20%"
# create new column that contains only numbers of string in 
# "tree_id" itree_3006 > 3006
df$ID <- as.numeric(gsub("itree_", "", df$tree_id))

# sort ascending by ID
df <- df[order(df$ID),]

# i-TREE TREES (itree_spec == 1)
df_itree <- df[df$itree_spec == 1,]
df_itree$class <- "i-Tree"

# ZONE 1 TREES (pollution_zone == 1)
df_z1 <- df[df$pollution_zone == 1,]
df_z1$class <- "Sone 1"

# ZONE 2 TREES (pollution_zone == 2)
df_z2 <- df[df$pollution_zone == 2,]
df_z2$class <- "Sone 2"

# ZONE 3 TREES (pollution_zone == 3)
df_z3 <- df[df$pollution_zone == 3,]

data_merged <- rbind(df, df_itree, df_z1, df_z2)
dat <- tibble::as_tibble(data_merged)

logger::log_info(paste0("Data loaded. \n", toString(df[1,3:6])))
```

### Registrerte trær i `r params$region`'s byggesonen

Dette dokumentet viser sammendragsstatistikken for registrerte trær innenfor `r params$region`'s byggesone. Tilknyttede kartprodukter er synlige i bytraeratlaset: [Bytræratlas `r params$region`](https://experience.arcgis.com/experience/%60r%20params$agol%60/)

| Gruppe     | Beskrivelse                             | Antall             |
|------------|-----------------------------------------|--------------------|
| Alle Trær  | Alle registrerte trær i Bodøs byggesone | `r nrow(df)`       |
| i-Tree Eco | i-Tree Eco trær                         | `r nrow(df_itree)` |
| Sone 1     | Trær i forurensningssone 1 (grønn)      | `r nrow(df_z1)`    |
| Sone 2     | Trær i forurensningssone 2 (gull)       | `r nrow(df_z2)`    |
| Sone 3     | Trær i forurensningssone 3 (rød)        | `r nrow(df_z3)`    |
|            |                                         |                    |

<br>

### Treslagsfordeling i `r params$region`

Treslag som har en sansynlighet på mindre enn 3% er klassifisert som "Andre treslag".

```{r "Tree Species Distribution", echo=FALSE, results='hide',message=FALSE, warning=FALSE}
# ---------------------------------------------------------------------------- #
# PLOT TRESLAG
# ---------------------------------------------------------------------------- #
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
# Function ------------------------------------------------------------------- #
#' Calculate summary statistics
#' @param data: data frame
#' @param x: variable name
#' @param classify_other: logical, if TRUE, classify all values with less than 3%
#' @return: a data frame with the summary statistics
#' @example
#' data <- data.frame(x = c("A", "B", "C", "C", "C"))
#' calc_summary(data, "x", classify_other = TRUE)
#' # A tibble: 3 x 3
#'  x         n  Perc
#' <chr> <int> <dbl>
#' 1 C         3  60
#' 2 A         1  20
#' 3 B         1  20

calc_summary <- function(data, x, classify_other = FALSE) {
  # remove NA values from x
  data <- data %>% tidyr::drop_na(!!rlang::sym(x))  

  # create summary dataframe df[x, n, perc]
  summary <- data %>%
    dplyr::count(!!rlang::sym(x)) %>%
    dplyr::mutate(Probability = n / sum(n),
                  Perc = round(Probability * 100, digits = 2)) %>%
    dplyr::arrange(desc(Perc))

  if (abs(sum(summary$Probability) - 1) > .Machine$double.eps^0.5) {
    stop("Error: Probability SUM != 1")
  }

  summary <- summary %>% dplyr::select(-Probability)

  if (classify_other) {
    summary_classified <- summary %>%
      dplyr::filter(Perc >= 3) %>%
      dplyr::bind_rows(dplyr::summarise(dplyr::filter(summary, Perc < 3), 
                          # !! is used to unquote the variable name 
                          # var_name <- "my_var" unquote: my_var 
                          !!rlang::sym(x) := "Andre treslag*", 
                          n = sum(n), 
                          Perc = sum(Perc)))
    return(summary_classified)
  }

  return(summary)
}

# -----------------------------------------------------------------------------#
# TRESLAGSFORDELING
# -----------------------------------------------------------------------------#

# calc. probability for "Alle Traer", "i-Tree", "Sone 1" and "Sone 2"
df_all_species <- df[!is.na(data_merged$norwegian_name) & 
                       data_merged$norwegian_name != "",]

# create a vector with the names of the trees with less than 3% probability
other_trees <- df_all_species %>%
  dplyr::count(norwegian_name) %>%
  dplyr::mutate(Probability = n / sum(n)) %>%
  dplyr::filter(Probability < 0.03) %>%
  dplyr::pull(norwegian_name)

summary_all <- calc_summary(df_all_species, 
                            "norwegian_name",
                            classify_other = TRUE)

df_itree_species <- df_itree[!is.na(df_itree$norwegian_name) & 
                               df_itree$norwegian_name != "",]
summary_itree <- calc_summary(df_itree_species, 
                              "norwegian_name",
                              classify_other = TRUE)

df_z1_species <- df_z1[!is.na(df_z1$norwegian_name) & 
                         df_z1$norwegian_name != "",]
summary_z1 <- calc_summary(df_z1_species,
                           "norwegian_name", 
                           classify_other = TRUE)

df_z2_species <- df_z2[!is.na(df_z2$norwegian_name) & 
                         df_z2$norwegian_name != "",]
summary_z2 <- calc_summary(df_z2_species,
                           "norwegian_name",
                           classify_other = TRUE)
```

```{r Probability Plot, echo=FALSE, results='hide',message=FALSE, warning=FALSE, fig.height=10, fig.width=14}
# ---------------------------------------------------------------------------- #
# PLOT TRESLAGFORDELING
# ---------------------------------------------------------------------------- #

plot_species_all <- nina_plot$probability_plot(
  data = summary_all, 
  Var1 = "norwegian_name", 
  title = paste0("Trær i ", params$region, "'s byggesone")) + 
  theme_minimal(base_family = "Roboto", base_size = 12) + 
  nina_theme$theme_large()

plot_species_itree <- nina_plot$probability_plot(
  data = summary_itree, 
  Var1 = "norwegian_name", 
  title = "i-Tree Eco trær") + 
  theme_minimal(base_family = "Roboto", base_size = 12) + 
  nina_theme$theme_large()

plot_species_z1 <- nina_plot$probability_plot(
  data = summary_z1, 
  Var1 = "norwegian_name", 
  title = "Trær i forurensningssone 1") + 
  theme_minimal(base_family = "Roboto", base_size = 12) + 
  nina_theme$theme_large()

plot_species_z2 <- nina_plot$probability_plot(
  data = summary_z2,
  Var1 = "norwegian_name",
  title = "Trær i forurensningssone 2") +
  theme_minimal(base_family = "Roboto", base_size = 12) +
  nina_theme$theme_large()

# arrange plots 
plots <- ggpubr::ggarrange(plot_species_all, 
                           plot_species_itree, 
                           plot_species_z1, 
                           plot_species_z2, 
                           ncol = 2, nrow = 2, align = "v")

print(plots)
# Create the labels
title <- cowplot::ggdraw() + 
  cowplot::draw_label(paste0("Treslagsfordeling i ", params$region), 
   fontfamily = "Roboto", 
   x = 0.02, y = -0.3, 
   hjust = 0, vjust = 0, 
   size = 16, color = "#000000",
   fontface = "bold")

subtitle <- cowplot::ggdraw() + 
  cowplot::draw_label("3% eller mindre av totalt antall trær klassifiseres som 'Andre treslag'.*",
  fontfamily = "Roboto", 
  x = 0.02, y = -0, 
  hjust = 0, vjust = -0.5, 
  size = 10, color = "#000000",
  fontface = "italic")
 

# Combine the labels and the plots
#plot_species_prob <- cowplot::plot_grid(title, subtitle, plots, ncol = 1, 
#                        rel_heights = c(0.05, 0.05, 1))

# Display the final plot
#print(plot_species_prob)
```


<font size="0.8" face="Arial">\*Treslag klassifisert som 'Andre treslag' er: `r other_trees` </font>

<br>

### Tre egenskaper

---------------------


```{r CROWN AREA, echo=FALSE, results='hide',message=FALSE, warning=FALSE, fig.height=3, fig.width = 14}
# ---------------------------------------------------------------------------- #
# PLOT KRONEAREAL (M2)
# ---------------------------------------------------------------------------- #
# calculate bins and labels
result <- nina_plot$calculate_bins(df, "crown_area", "fd")
result_itree <- nina_plot$calculate_bins(df_itree, "crown_area", "fd")
result_z1 <- nina_plot$calculate_bins(df_z1, "crown_area", "fd")
result_z2 <- nina_plot$calculate_bins(df_z2, "crown_area", "fd")
ymax <- max(table(cut(df[["crown_area"]], breaks = seq(0, result$bin_max, by = result$bin_step), include.lowest = TRUE)))
logger::log_info(paste0("ymax: ", ymax))
ymax = 600
histogram_all <- nina_plot$histogram(data = result$temp_data, 
                                      value_col = "crown_area", 
                                      bin_max = 250,
                                      bin_step = 5, 
                                      lab_step = 40, 
                                      ymax = ymax,
                                      title = "Alle trær",
                                      axis_title_x = "Kroneareal (m2)") + theme_minimal(base_family = "Roboto", base_size = 12) + 
  nina_theme$theme_medium()
histogram_itree <- nina_plot$histogram(data = result_itree$temp_data, 
                                      value_col = "crown_area", 
                                      bin_max = 250,
                                      bin_step = 5, 
                                      lab_step = 40, 
                                      ymax = ymax,
                                      title = "i-Tree Eco",
                                      axis_title_x = "Kroneareal (m2)") + theme_minimal(base_family = "Roboto", base_size = 12) + 
  nina_theme$theme_medium()
histogram_z1 <- nina_plot$histogram(data = result_z1$temp_data, 
                                      value_col = "crown_area", 
                                      bin_max = 250, 
                                      bin_step = 5, 
                                      lab_step = 40, 
                                      ymax = ymax,
                                      title = "Sone 1",
                                      axis_title_x = "Kroneareal (m2)") + theme_minimal(base_family = "Roboto", base_size = 12) + 
  nina_theme$theme_medium()
histogram_z2 <- nina_plot$histogram(data = result_z2$temp_data, 
                                      value_col = "crown_area", 
                                      bin_max = result_z2$bin_max, 
                                      bin_step = result_z2$bin_step, 
                                      lab_step = result_z2$lab_step, 
                                      ymax = ymax,
                                      title = "Sone 2",
                                      axis_title_x = "Kroneareal (m2)") + theme_minimal(base_family = "Roboto", base_size = 12) + 
  nina_theme$theme_medium()

# Arrange the plots
plots <- ggpubr::ggarrange(histogram_all,
                   histogram_itree,
                   histogram_z1,
                   histogram_z2,
                   ncol = 4, nrow = 1, align = "v")
# Create the labels
title <- cowplot::ggdraw() + cowplot::draw_label("Kroneareal", 
                               fontfamily = "Arial", 
                               x = 0.45, y = 0.2, 
                               hjust = 0, vjust = 0, 
                               size = 14, color = "#000000",
                               fontface = "bold")
# Combine the labels and the plots
plot_dbh <- cowplot::plot_grid(title, plots, ncol = 1, rel_heights = c(0.2, 1))

# Display the final plot
print(plot_dbh)
```

```{r HEIGHT, echo=FALSE, results='hide',message=FALSE, warning=FALSE, fig.height=3, fig.width = 14}
# ---------------------------------------------------------------------------- #
# PLOT HØYDE (M)
# ---------------------------------------------------------------------------- #
# calculate bins and labels
result <- nina_plot$calculate_bins(df, "height_total_tree", "fd")
result_itree <- nina_plot$calculate_bins(df_itree, "height_total_tree", "fd")
result_z1 <- nina_plot$calculate_bins(df_z1, "height_total_tree", "fd")
result_z2 <- nina_plot$calculate_bins(df_z2, "height_total_tree", "fd")
ymax <- max(table(cut(df[["height_total_tree"]], breaks = seq(0, result$bin_max, by = result$bin_step), include.lowest = TRUE)))
logger::log_info(paste0("ymax: ", ymax))

histogram_all <- nina_plot$histogram(data = result$temp_data, 
                                      value_col = "height_total_tree", 
                                      bin_max = result$bin_max, 
                                      bin_step = result$bin_step, 
                                      lab_step = result$lab_step, 
                                      ymax = ymax,
                                      title = "Alle trær",
                                      axis_title_x = "Høyde (m)") + theme_minimal(base_family = "Roboto", base_size = 12) + 
  nina_theme$theme_medium()
histogram_itree <- nina_plot$histogram(data = result_itree$temp_data, 
                                      value_col = "height_total_tree", 
                                      bin_max = result_itree$bin_max, 
                                      bin_step = result_itree$bin_step, 
                                      lab_step = result_itree$lab_step, 
                                      ymax = ymax,
                                      title = "i-Tree Eco",
                                      axis_title_x = "Høyde (m)") + theme_minimal(base_family = "Roboto", base_size = 12) + 
  nina_theme$theme_medium()
histogram_z1 <- nina_plot$histogram(data = result_z1$temp_data, 
                                      value_col = "height_total_tree", 
                                      bin_max = result_z1$bin_max, 
                                      bin_step = result_z1$bin_step, 
                                      lab_step = result_z1$lab_step, 
                                      ymax = ymax,
                                      title = "Sone 1",
                                      axis_title_x = "Høyde (m)") + theme_minimal(base_family = "Roboto", base_size = 12) + 
  nina_theme$theme_medium()
histogram_z2 <- nina_plot$histogram(data = result_z2$temp_data, 
                                      value_col = "height_total_tree", 
                                      bin_max = result_z2$bin_max, 
                                      bin_step = result_z2$bin_step, 
                                      lab_step = result_z2$lab_step, 
                                      ymax = ymax,
                                      title = "Sone 2",
                                      axis_title_x = "Høyde (m)") + theme_minimal(base_family = "Roboto", base_size = 12) + 
  nina_theme$theme_medium()

# Arrange the plots
plots <- ggpubr::ggarrange(histogram_all,
                   histogram_itree,
                   histogram_z1,
                   histogram_z2,
                   ncol = 4, nrow = 1, align = "v")
# Create the labels
title <- cowplot::ggdraw() + cowplot::draw_label("Høyde", 
                               fontfamily = "Arial", 
                               x = 0.45, y = 0.2, 
                               hjust = 0, vjust = 0, 
                               size = 14, color = "#000000",
                               fontface = "bold")
# Combine the labels and the plots
plot_dbh <- cowplot::plot_grid(title, plots, ncol = 1, rel_heights = c(0.2, 1))

# Display the final plot
print(plot_dbh)
```
```{r DBH, echo=FALSE, results='hide',message=FALSE, warning=FALSE, fig.height=3, fig.width = 14}
# ---------------------------------------------------------------------------- #
# PLOT "Stammeomkrets (cm)"
# ---------------------------------------------------------------------------- #
# calculate bins and labels
result <- nina_plot$calculate_bins(df, "dbh", "fd")
result_itree <- nina_plot$calculate_bins(df_itree, "dbh", "fd")
result_z1 <- nina_plot$calculate_bins(df_z1, "dbh", "fd")
result_z2 <- nina_plot$calculate_bins(df_z2, "dbh", "fd")
ymax <- max(table(cut(df[["dbh"]], breaks = seq(0, result$bin_max, by = result$bin_step), include.lowest = TRUE)))
logger::log_info(paste0("ymax: ", ymax))

histogram_all <- nina_plot$histogram(data = result$temp_data, 
                                      value_col = "dbh", 
                                      bin_max = result$bin_max, 
                                      bin_step = result$bin_step, 
                                      lab_step = result$lab_step*2, 
                                      ymax = ymax,
                                      title = "Alle trær",
                                      axis_title_x = "Stammeomkrets (cm)") + theme_minimal(base_family = "Roboto", base_size = 12) + 
  nina_theme$theme_medium()
histogram_itree <- nina_plot$histogram(data = result_itree$temp_data, 
                                      value_col = "dbh", 
                                      bin_max = result_itree$bin_max, 
                                      bin_step = result_itree$bin_step, 
                                      lab_step = result_itree$lab_step*2, 
                                      ymax = ymax,
                                      title = "i-Tree Eco",
                                      axis_title_x = "Stammeomkrets (cm)") + theme_minimal(base_family = "Roboto", base_size = 12) + 
  nina_theme$theme_medium()
histogram_z1 <- nina_plot$histogram(data = result_z1$temp_data, 
                                      value_col = "dbh", 
                                      bin_max = result_z1$bin_max, 
                                      bin_step = result_z1$bin_step, 
                                      lab_step = result_z1$lab_step*2, 
                                      ymax = ymax,
                                      title = "Sone 1",
                                      axis_title_x = "Stammeomkrets (cm)") + theme_minimal(base_family = "Roboto", base_size = 12) + 
  nina_theme$theme_medium()
histogram_z2 <- nina_plot$histogram(data = result_z2$temp_data, 
                                      value_col = "dbh", 
                                      bin_max = result_z2$bin_max, 
                                      bin_step = result_z2$bin_step, 
                                      lab_step = result_z2$lab_step, 
                                      ymax = ymax,
                                      title = "Sone 2",
                                      axis_title_x = "Stammeomkrets (cm)") + theme_minimal(base_family = "Roboto", base_size = 12) + 
  nina_theme$theme_medium()

# Arrange the plots
plots <- ggpubr::ggarrange(histogram_all,
                   histogram_itree,
                   histogram_z1,
                   histogram_z2,
                   ncol = 4, nrow = 1, align = "v")
# Create the labels
title <- cowplot::ggdraw() + cowplot::draw_label("Stammeomkrets", 
                               fontfamily = "Arial", 
                               x = 0.45, y = 0.2, 
                               hjust = 0, vjust = 0, 
                               size = 14, color = "#000000",
                               fontface = "bold")
# Combine the labels and the plots
plot_dbh <- cowplot::plot_grid(title, plots, ncol = 1, rel_heights = c(0.2, 1))

# Display the final plot
print(plot_dbh)
```
